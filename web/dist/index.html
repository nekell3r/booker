<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booker - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .bookings-list {
            display: grid;
            gap: 1rem;
        }
        
        .booking-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .booking-info h3 {
            margin-bottom: 0.5rem;
        }
        
        .booking-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-held {
            background: #f39c12;
            color: white;
        }
        
        .status-confirmed {
            background: #3498db;
            color: white;
        }
        
        .status-seated {
            background: #27ae60;
            color: white;
        }
        
        .status-finished {
            background: #95a5a6;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .venue-details {
            margin-top: 1rem;
        }
        
        .venue-details h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .room-card, .table-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .capacity-badge {
            background: #3498db;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .back-button {
            margin-bottom: 1rem;
        }
        
        .modal-content h2 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Booker - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h1>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('today', event)">–°–µ–≥–æ–¥–Ω—è</button>
            <button class="tab" onclick="showTab('bookings', event)">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</button>
            <button class="tab" onclick="showTab('venues', event)">–ó–∞–≤–µ–¥–µ–Ω–∏—è</button>
        </div>
        
        <div class="content" id="today-tab">
            <h2>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
            <div class="bookings-list" id="bookings-list">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <button class="btn btn-primary" onclick="openCreateModal()" style="margin-top: 1rem;">
                –°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
        </div>
        
        <div class="content" id="bookings-tab" style="display: none;">
            <h2>–í—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
            <div class="bookings-list" id="all-bookings-list">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
        
        <div class="content" id="venues-tab" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>–ó–∞–≤–µ–¥–µ–Ω–∏—è</h2>
                <button class="btn btn-primary" onclick="openCreateVenueModal()">–°–æ–∑–¥–∞—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ</button>
            </div>
            <div id="venues-list">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>
    
    <!-- Create Booking Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <form id="create-form" onsubmit="createBooking(event)">
                <div class="form-group">
                    <label>–ó–∞–≤–µ–¥–µ–Ω–∏–µ</label>
                    <select id="booking-venue" required onchange="loadRoomsForBooking()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ó–∞–ª</label>
                    <select id="booking-room" required onchange="loadTablesForBooking()">
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–°—Ç–æ–ª</label>
                    <select id="booking-table" required onchange="updateTableCapacity()">
                        <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>
                    </select>
                    <small id="table-capacity-info" style="display: none; color: #666; margin-top: 0.25rem;"></small>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞</label>
                    <input type="date" id="booking-date" required>
                </div>
                <div class="form-group">
                    <label>–í—Ä–µ–º—è</label>
                    <input type="time" id="booking-time" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
                    <input type="number" id="party-size" min="1" required>
                </div>
                <div class="form-group">
                    <label>–ò–º—è –≥–æ—Å—Ç—è</label>
                    <input type="text" id="customer-name" required>
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" id="customer-phone" required>
                </div>
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input type="text" id="comment">
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Venue Details Modal -->
    <div class="modal" id="venue-details-modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h2 id="venue-details-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ–º</h2>
            <div id="venue-details-content">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="button" class="btn" onclick="closeVenueDetailsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- Create Room Modal -->
    <div class="modal" id="create-room-modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–ª</h2>
            <form id="create-room-form" onsubmit="createRoom(event)">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ª–∞</label>
                    <input type="text" id="room-name" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn" onclick="closeCreateRoomModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Create Table Modal -->
    <div class="modal" id="create-table-modal">
        <div class="modal-content">
            <h2>–°–æ–∑–¥–∞—Ç—å —Å—Ç–æ–ª</h2>
            <form id="create-table-form" onsubmit="createTable(event)">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–æ–ª–∞</label>
                    <input type="text" id="table-name" required>
                </div>
                <div class="form-group">
                    <label>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç)</label>
                    <input type="number" id="table-capacity" min="1" required>
                </div>
                <div class="form-group">
                    <label>–ó–æ–Ω–∞</label>
                    <input type="text" id="table-zone" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–∫–Ω–æ, —Ç–µ—Ä—Ä–∞—Å–∞">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="table-can-merge" style="width: auto; margin-right: 0.5rem;">
                        –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Å—Ç–æ–ª–∞–º–∏
                    </label>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å</button>
                    <button type="button" class="btn" onclick="closeCreateTableModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api/v1';
        let token = 'dummy-token'; // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ localStorage
        
        function showTab(tab, evt) {
            console.log('showTab called:', tab);
            
            // Hide all content tabs
            const allContents = document.querySelectorAll('.content');
            console.log('Found content elements:', allContents.length);
            allContents.forEach(c => {
                c.style.display = 'none';
                console.log('Hiding:', c.id);
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected tab button
            const clickedTab = evt ? evt.target : document.querySelector(`.tab[onclick*="${tab}"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
                console.log('Activated tab button:', clickedTab.textContent);
            }
            
            // Show selected content
            const tabContent = document.getElementById(tab + '-tab');
            console.log('Looking for tab content:', tab + '-tab', 'Found:', tabContent);
            if (tabContent) {
                tabContent.style.display = 'block';
                console.log('Showing content:', tabContent.id);
            } else {
                console.error('Tab content not found:', tab + '-tab');
            }
            
            // Load tab content
            if (tab === 'today') {
                console.log('Loading today bookings');
                loadBookings();
            } else if (tab === 'bookings') {
                console.log('Loading all bookings');
                loadAllBookings();
            } else if (tab === 'venues') {
                console.log('Loading venues');
                loadVenues();
            }
        }
        
        async function loadBookings() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${API_BASE}/bookings?date=${today}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                renderBookings(data.bookings || [], 'bookings-list');
            } catch (error) {
                console.error('Failed to load bookings:', error);
                document.getElementById('bookings-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
        
        async function loadAllBookings() {
            try {
                const response = await fetch(`${API_BASE}/bookings`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                renderBookings(data.bookings || [], 'all-bookings-list');
            } catch (error) {
                console.error('Failed to load bookings:', error);
                document.getElementById('all-bookings-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
        
        function renderBookings(bookings, listId = 'bookings-list') {
            const list = document.getElementById(listId);
            if (bookings.length === 0) {
                list.innerHTML = '<p>–ù–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>';
                return;
            }
            
            list.innerHTML = bookings.map(booking => `
                <div class="booking-card">
                    <div class="booking-info">
                        <h3>${booking.customer_name}</h3>
                        <p>${booking.slot.date} ${booking.slot.start_time} | ${booking.party_size} –≥–æ—Å—Ç–µ–π</p>
                        <p>–°—Ç–æ–ª: ${booking.table.table_id}</p>
                        <span class="status status-${booking.status}">${booking.status}</span>
                    </div>
                    <div class="booking-actions">
                        ${booking.status === 'held' ? `<button class="btn btn-success" onclick="confirmBooking('${booking.id}')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : ''}
                        ${booking.status === 'confirmed' ? `<button class="btn btn-success" onclick="markSeated('${booking.id}')">–ü–æ—Å–∞–¥–∏—Ç—å</button>` : ''}
                        ${booking.status === 'seated' ? `<button class="btn btn-primary" onclick="markFinished('${booking.id}')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>` : ''}
                        ${['held', 'confirmed'].includes(booking.status) ? `<button class="btn btn-danger" onclick="cancelBooking('${booking.id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        async function loadVenues() {
            try {
                console.log('loadVenues: sending request to', `${API_BASE}/venues`);
                const response = await fetch(`${API_BASE}/venues`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                console.log('loadVenues: response status', response.status, response.statusText);
                const data = await response.json();
                console.log('loadVenues: received data', data);
                renderVenues(data.venues || []);
            } catch (error) {
                console.error('Failed to load venues:', error);
                document.getElementById('venues-list').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
        
        function renderVenues(venues) {
            const list = document.getElementById('venues-list');
            if (venues.length === 0) {
                list.innerHTML = '<p>–ù–µ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ.</p>';
                return;
            }
            
            list.innerHTML = venues.map(venue => `
                <div class="booking-card" style="margin-bottom: 1rem;">
                    <div class="booking-info" style="flex: 1;">
                        <h3>${venue.name}</h3>
                        <p>${venue.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p>ID: ${venue.id}</p>
                    </div>
                    <div class="booking-actions">
                        <button class="btn btn-primary" onclick="loadVenueDetails('${venue.id}')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                        <button class="btn btn-danger" onclick="deleteVenue('${venue.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }
        
        let currentVenueId = null;
        let currentRoomId = null;
        
        async function loadVenueDetails(venueId) {
            currentVenueId = venueId;
            document.getElementById('venue-details-modal').classList.add('active');
            
            try {
                // Load venue info
                const venueResp = await fetch(`${API_BASE}/venues/${venueId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const venue = await venueResp.json();
                
                document.getElementById('venue-details-title').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${venue.name}`;
                
                // Load rooms
                const roomsResp = await fetch(`${API_BASE}/venues/${venueId}/rooms`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const roomsData = await roomsResp.json();
                const rooms = roomsData.rooms || [];
                
                let html = `
                    <div style="margin-bottom: 1rem;">
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${venue.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                    <h3>–ó–∞–ª—ã</h3>
                    <button class="btn btn-primary" onclick="openCreateRoomModal('${venueId}')" style="margin-bottom: 1rem;">–°–æ–∑–¥–∞—Ç—å –∑–∞–ª</button>
                    <div id="rooms-list">
                `;
                
                if (rooms.length === 0) {
                    html += '<p>–ù–µ—Ç –∑–∞–ª–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–ª.</p>';
                } else {
                    for (const room of rooms) {
                        html += `
                            <div class="room-card">
                                <div>
                                    <strong>${room.name}</strong>
                                    <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">ID: ${room.id}</p>
                                </div>
                                <div class="booking-actions">
                                    <button class="btn btn-primary" onclick="loadRoomTables('${venueId}', '${room.id}')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–∞–º–∏</button>
                                    <button class="btn btn-danger" onclick="deleteRoom('${venueId}', '${room.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
                document.getElementById('venue-details-content').innerHTML = html;
            } catch (error) {
                console.error('Failed to load venue details:', error);
                document.getElementById('venue-details-content').innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
        
        function closeVenueDetailsModal() {
            document.getElementById('venue-details-modal').classList.remove('active');
            currentVenueId = null;
            currentRoomId = null;
        }
        
        async function loadRoomTables(venueId, roomId) {
            currentRoomId = roomId;
            
            try {
                const tablesResp = await fetch(`${API_BASE}/rooms/${roomId}/tables`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const tablesData = await tablesResp.json();
                const tables = tablesData.tables || [];
                
                // Load room info
                const roomResp = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const room = await roomResp.json();
                
                let html = `
                    <button class="btn back-button" onclick="loadVenueDetails('${venueId}')">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–ª–∞–º</button>
                    <h3>–°—Ç–æ–ª—ã –≤ –∑–∞–ª–µ "${room.name}"</h3>
                    <button class="btn btn-primary" onclick="openCreateTableModal('${venueId}', '${roomId}')" style="margin-bottom: 1rem;">–°–æ–∑–¥–∞—Ç—å —Å—Ç–æ–ª</button>
                    <div id="tables-list">
                `;
                
                if (tables.length === 0) {
                    html += '<p>–ù–µ—Ç —Å—Ç–æ–ª–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª.</p>';
                } else {
                    for (const table of tables) {
                        html += `
                            <div class="table-card">
                                <div class="table-info">
                                    <div>
                                        <strong>${table.name}</strong>
                                        <p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">ID: ${table.id}</p>
                                        ${table.zone ? `<p style="margin: 0.25rem 0; color: #666; font-size: 0.9rem;">–ó–æ–Ω–∞: ${table.zone}</p>` : ''}
                                    </div>
                                    <span class="capacity-badge">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${table.capacity}</span>
                                    ${table.can_merge ? '<span style="color: #27ae60; font-size: 0.85rem;">‚úì –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω—è—Ç—å</span>' : ''}
                                </div>
                                <div class="booking-actions">
                                    <button class="btn btn-danger" onclick="deleteTable('${venueId}', '${roomId}', '${table.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                        `;
                    }
                }
                
                html += '</div>';
                document.getElementById('venue-details-content').innerHTML = html;
            } catch (error) {
                console.error('Failed to load tables:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–ª–æ–≤');
            }
        }
        
        function openCreateRoomModal(venueId) {
            currentVenueId = venueId;
            document.getElementById('create-room-modal').classList.add('active');
            document.getElementById('room-name').value = '';
        }
        
        function closeCreateRoomModal() {
            document.getElementById('create-room-modal').classList.remove('active');
        }
        
        async function createRoom(event) {
            event.preventDefault();
            const name = document.getElementById('room-name').value;
            
            try {
                const response = await fetch(`${API_BASE}/venues/${currentVenueId}/rooms`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                if (response.ok) {
                    closeCreateRoomModal();
                    loadVenueDetails(currentVenueId);
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ª–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('Failed to create room:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ª–∞');
            }
        }
        
        function openCreateTableModal(venueId, roomId) {
            currentVenueId = venueId;
            currentRoomId = roomId;
            document.getElementById('create-table-modal').classList.add('active');
            document.getElementById('table-name').value = '';
            document.getElementById('table-capacity').value = '';
            document.getElementById('table-zone').value = '';
            document.getElementById('table-can-merge').checked = false;
        }
        
        function closeCreateTableModal() {
            document.getElementById('create-table-modal').classList.remove('active');
        }
        
        async function createTable(event) {
            event.preventDefault();
            const name = document.getElementById('table-name').value;
            const capacity = parseInt(document.getElementById('table-capacity').value);
            const zone = document.getElementById('table-zone').value;
            const canMerge = document.getElementById('table-can-merge').checked;
            
            try {
                const response = await fetch(`${API_BASE}/rooms/${currentRoomId}/tables`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, capacity, zone, can_merge: canMerge })
                });
                
                if (response.ok) {
                    closeCreateTableModal();
                    loadRoomTables(currentVenueId, currentRoomId);
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–æ–ª–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('Failed to create table:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–æ–ª–∞');
            }
        }
        
        async function deleteRoom(venueId, roomId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ª? –í—Å–µ —Å—Ç–æ–ª—ã –≤ —ç—Ç–æ–º –∑–∞–ª–µ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
            
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadVenueDetails(venueId);
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ª–∞');
                }
            } catch (error) {
                console.error('Failed to delete room:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ª–∞');
            }
        }
        
        async function deleteTable(venueId, roomId, tableId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç–æ–ª?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/tables/${tableId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadRoomTables(venueId, roomId);
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–æ–ª–∞');
                }
            } catch (error) {
                console.error('Failed to delete table:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–æ–ª–∞');
            }
        }
        
        async function deleteVenue(venueId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–≤–µ–¥–µ–Ω–∏–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
            try {
                console.log('deleteVenue: sending DELETE request to', `${API_BASE}/venues/${venueId}`);
                const response = await fetch(`${API_BASE}/venues/${venueId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                console.log('deleteVenue: response status', response.status, response.statusText);
                if (response.ok) {
                    loadVenues();
                } else {
                    const errorText = await response.text();
                    console.error('deleteVenue: error response', errorText);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Failed to delete venue:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è');
            }
        }
        
        function openCreateVenueModal() {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è:');
            if (!name) return;
            const address = prompt('–ê–¥—Ä–µ—Å:');
            if (!address) return;
            const timezone = prompt('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, Europe/Moscow):', 'Europe/Moscow');
            
            createVenue({ name, address, timezone: timezone || 'Europe/Moscow' });
        }
        
        async function createVenue(venue) {
            try {
                console.log('createVenue: sending POST request to', `${API_BASE}/venues`, venue);
                const response = await fetch(`${API_BASE}/venues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(venue)
                });
                console.log('createVenue: response status', response.status, response.statusText);
                if (response.ok) {
                    loadVenues();
                } else {
                    const error = await response.json();
                    console.error('createVenue: error response', error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('Failed to create venue:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–≤–µ–¥–µ–Ω–∏—è');
            }
        }
        
        async function confirmBooking(id) {
            try {
                const response = await fetch(`${API_BASE}/bookings/${id}/confirm`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    // Reload current tab
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab && activeTab.textContent.includes('–°–µ–≥–æ–¥–Ω—è')) {
                        loadBookings();
                    } else {
                        loadAllBookings();
                    }
                }
            } catch (error) {
                console.error('Failed to confirm booking:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
        
        async function markSeated(id) {
            try {
                const response = await fetch(`${API_BASE}/bookings/${id}/seat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab && activeTab.textContent.includes('–°–µ–≥–æ–¥–Ω—è')) {
                        loadBookings();
                    } else {
                        loadAllBookings();
                    }
                }
            } catch (error) {
                console.error('Failed to mark seated:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –æ –ø–æ—Å–∞–¥–∫–µ');
            }
        }
        
        async function markFinished(id) {
            try {
                const response = await fetch(`${API_BASE}/bookings/${id}/finish`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab && activeTab.textContent.includes('–°–µ–≥–æ–¥–Ω—è')) {
                        loadBookings();
                    } else {
                        loadAllBookings();
                    }
                }
            } catch (error) {
                console.error('Failed to mark finished:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
        
        async function cancelBooking(id) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) return;
            try {
                const response = await fetch(`${API_BASE}/bookings/${id}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: '–û—Ç–º–µ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º' })
                });
                if (response.ok) {
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab && activeTab.textContent.includes('–°–µ–≥–æ–¥–Ω—è')) {
                        loadBookings();
                    } else {
                        loadAllBookings();
                    }
                }
            } catch (error) {
                console.error('Failed to cancel booking:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
        
        async function openCreateModal() {
            document.getElementById('create-modal').classList.add('active');
            document.getElementById('booking-date').value = new Date().toISOString().split('T')[0];
            
            // Load venues
            try {
                const response = await fetch(`${API_BASE}/venues`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const venues = data.venues || [];
                
                const venueSelect = document.getElementById('booking-venue');
                venueSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ</option>';
                venues.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.id;
                    option.textContent = venue.name;
                    venueSelect.appendChild(option);
                });
                
                // Reset other selects
                document.getElementById('booking-room').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ</option>';
                document.getElementById('booking-table').innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>';
                document.getElementById('table-capacity-info').style.display = 'none';
            } catch (error) {
                console.error('Failed to load venues:', error);
            }
        }
        
        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
        }
        
        async function loadRoomsForBooking() {
            const venueId = document.getElementById('booking-venue').value;
            const roomSelect = document.getElementById('booking-room');
            const tableSelect = document.getElementById('booking-table');
            
            roomSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            tableSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>';
            document.getElementById('table-capacity-info').style.display = 'none';
            
            if (!venueId) {
                roomSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ</option>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/venues/${venueId}/rooms`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const rooms = data.rooms || [];
                
                roomSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>';
                rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load rooms:', error);
                roomSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        async function loadTablesForBooking() {
            const roomId = document.getElementById('booking-room').value;
            const tableSelect = document.getElementById('booking-table');
            
            tableSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
            document.getElementById('table-capacity-info').style.display = 'none';
            
            if (!roomId) {
                tableSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ª</option>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/rooms/${roomId}/tables`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const tables = data.tables || [];
                
                tableSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª</option>';
                tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table.id;
                    option.textContent = `${table.name} (–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${table.capacity})`;
                    option.dataset.capacity = table.capacity;
                    option.dataset.roomId = roomId;
                    tableSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load tables:', error);
                tableSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            }
        }
        
        async function updateTableCapacity() {
            const tableSelect = document.getElementById('booking-table');
            const selectedOption = tableSelect.options[tableSelect.selectedIndex];
            const capacityInfo = document.getElementById('table-capacity-info');
            const partySizeInput = document.getElementById('party-size');
            const partySize = parseInt(partySizeInput.value) || 0;
            
            // Hide merge suggestions
            const mergeSuggestions = document.getElementById('merge-suggestions');
            if (mergeSuggestions) {
                mergeSuggestions.style.display = 'none';
            }
            
            if (selectedOption && selectedOption.value) {
                const capacity = parseInt(selectedOption.dataset.capacity);
                capacityInfo.textContent = `–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ç–æ–ª–∞: ${capacity} –º–µ—Å—Ç`;
                capacityInfo.style.display = 'block';
                
                // Don't restrict max value - allow user to enter any number
                // We'll check for merge options if party size exceeds capacity
                
                // If party size exceeds capacity, check for merge options
                if (partySize > capacity) {
                    await checkMergeOptions();
                }
            } else {
                capacityInfo.style.display = 'none';
            }
        }
        
        async function checkMergeOptions() {
            const venueId = document.getElementById('booking-venue').value;
            const roomId = document.getElementById('booking-room').value;
            const tableId = document.getElementById('booking-table').value;
            const partySize = parseInt(document.getElementById('party-size').value);
            const date = document.getElementById('booking-date').value;
            const time = document.getElementById('booking-time').value;
            
            if (!venueId || !date || !time || !partySize) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/availability/check`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        venue_id: venueId,
                        slot: {
                            date: date,
                            start_time: time,
                            duration_minutes: 120
                        },
                        party_size: partySize
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Availability check response:', JSON.stringify(data, null, 2));
                    console.log('Tables:', data.tables);
                    if (data.tables && data.tables.length > 0) {
                        console.log('First table (full):', JSON.stringify(data.tables[0], null, 2));
                        console.log('First table keys:', Object.keys(data.tables[0]));
                        if (data.tables[0].merged_with_table) {
                            console.log('Merged with table (snake_case):', data.tables[0].merged_with_table);
                        }
                        if (data.tables[0].mergedWithTable) {
                            console.log('Merged with table (camelCase):', data.tables[0].mergedWithTable);
                        }
                    }
                    showMergeSuggestions(data.tables || [], tableId);
                }
            } catch (error) {
                console.error('Failed to check merge options:', error);
            }
        }
        
        function showMergeSuggestions(tables, selectedTableId) {
            // Remove existing merge suggestions
            let mergeDiv = document.getElementById('merge-suggestions');
            if (!mergeDiv) {
                mergeDiv = document.createElement('div');
                mergeDiv.id = 'merge-suggestions';
                mergeDiv.style.marginTop = '1rem';
                mergeDiv.style.padding = '1rem';
                mergeDiv.style.background = '#fff3cd';
                mergeDiv.style.border = '1px solid #ffc107';
                mergeDiv.style.borderRadius = '4px';
                document.getElementById('booking-table').parentElement.appendChild(mergeDiv);
            }
            
            // Filter tables that suggest merging
            const mergeOptions = tables.filter(t => 
                t.reason && t.reason.includes('Can be merged') && 
                t.table.table_id === selectedTableId
            );
            
            if (mergeOptions.length === 0) {
                mergeDiv.style.display = 'none';
                // Clear stored merge info
                mergeDiv.dataset.mergedTableId = '';
                mergeDiv.dataset.mergedRoomId = '';
                return;
            }
            
            // Store merged table info in dataset for later use
            const mergeOption = mergeOptions[0];
            console.log('Merge option:', mergeOption);
            console.log('Merged with table (snake_case):', mergeOption.merged_with_table);
            console.log('Merged with table (camelCase):', mergeOption.mergedWithTable);
            
            // Try both snake_case and camelCase (protobuf JSON can use either)
            const mergedTable = mergeOption.merged_with_table || mergeOption.mergedWithTable;
            if (mergedTable) {
                const mergedTableId = mergedTable.table_id || mergedTable.tableId || '';
                const mergedRoomId = mergedTable.room_id || mergedTable.roomId || '';
                console.log('Storing merged table:', mergedTableId, 'room:', mergedRoomId);
                mergeDiv.dataset.mergedTableId = mergedTableId;
                mergeDiv.dataset.mergedRoomId = mergedRoomId;
            } else {
                console.warn('No merged_with_table or mergedWithTable found in merge option');
            }
            
            mergeDiv.innerHTML = `
                <strong>üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é —Å—Ç–æ–ª–æ–≤:</strong>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                    ${mergeOptions.map(opt => `<li>${opt.reason}</li>`).join('')}
                </ul>
                <small style="color: #666;">–í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–æ–ª, –∏ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–±—Ä–æ–Ω–∏—Ä—É–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —Å—Ç–æ–ª—ã.</small>
            `;
            mergeDiv.style.display = 'block';
        }
        
        // Check merge options when party size changes
        document.addEventListener('DOMContentLoaded', function() {
            const partySizeInput = document.getElementById('party-size');
            if (partySizeInput) {
                partySizeInput.addEventListener('input', function() {
                    setTimeout(updateTableCapacity, 300); // Debounce
                });
            }
        });
        
        async function createBooking(event) {
            event.preventDefault();
            
            const venueId = document.getElementById('booking-venue').value;
            const roomId = document.getElementById('booking-room').value;
            const tableId = document.getElementById('booking-table').value;
            const partySize = parseInt(document.getElementById('party-size').value);
            
            if (!venueId || !roomId || !tableId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ, –∑–∞–ª –∏ —Å—Ç–æ–ª');
                return;
            }
            
            // Check capacity
            const tableSelect = document.getElementById('booking-table');
            const selectedOption = tableSelect.options[tableSelect.selectedIndex];
            const tableCapacity = parseInt(selectedOption.dataset.capacity);
            
            // Check if there's a merge suggestion
            const mergeSuggestions = document.getElementById('merge-suggestions');
            const hasMergeOption = mergeSuggestions && mergeSuggestions.style.display !== 'none';
            
            if (partySize > tableCapacity && !hasMergeOption) {
                alert(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π (${partySize}) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ç–æ–ª–∞ (${tableCapacity}). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å—Ç–æ–ª –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è.`);
                return;
            }
            
            // Get merged table info if available
            const mergedTableId = hasMergeOption ? (mergeSuggestions.dataset.mergedTableId || '') : '';
            const mergedRoomId = hasMergeOption ? (mergeSuggestions.dataset.mergedRoomId || '') : '';
            console.log('Creating booking - hasMergeOption:', hasMergeOption, 'mergedTableId:', mergedTableId, 'mergedRoomId:', mergedRoomId);
            
            // Create booking for primary table
            const booking = {
                venue_id: venueId,
                table: {
                    venue_id: venueId,
                    room_id: roomId,
                    table_id: tableId
                },
                slot: {
                    date: document.getElementById('booking-date').value,
                    start_time: document.getElementById('booking-time').value,
                    duration_minutes: 120
                },
                party_size: partySize,
                customer_name: document.getElementById('customer-name').value,
                customer_phone: document.getElementById('customer-phone').value,
                comment: document.getElementById('comment').value
            };
            
            try {
                // Create booking for primary table
                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(booking)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                    return;
                }
                
                // If there's a merged table, create booking for it too
                if (hasMergeOption && mergedTableId) {
                    console.log('Creating merged booking for table:', mergedTableId, 'room:', mergedRoomId);
                    const mergedBooking = {
                        venue_id: venueId,
                        table: {
                            venue_id: venueId,
                            room_id: mergedRoomId || roomId,
                            table_id: mergedTableId
                        },
                        slot: {
                            date: document.getElementById('booking-date').value,
                            start_time: document.getElementById('booking-time').value,
                            duration_minutes: 120
                        },
                        party_size: partySize,
                        customer_name: document.getElementById('customer-name').value,
                        customer_phone: document.getElementById('customer-phone').value,
                        comment: `–û–±—ä–µ–¥–∏–Ω–µ–Ω–æ —Å–æ —Å—Ç–æ–ª–æ–º ${tableId}. ${document.getElementById('comment').value || ''}`.trim()
                    };
                    
                    console.log('Sending merged booking request:', mergedBooking);
                    const mergedResponse = await fetch(`${API_BASE}/bookings`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(mergedBooking)
                    });
                    
                    console.log('Merged booking response status:', mergedResponse.status);
                    if (!mergedResponse.ok) {
                        const error = await mergedResponse.json();
                        alert(`–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ç–æ–ª–∞, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å—Ç–æ–ª: ${error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                        loadBookings();
                        closeCreateModal();
                        return;
                    }
                }
                
                // Both bookings created successfully
                closeCreateModal();
                // Reload current tab
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.textContent.includes('–°–µ–≥–æ–¥–Ω—è')) {
                    loadBookings();
                } else {
                    loadAllBookings();
                }
            } catch (error) {
                console.error('Failed to create booking:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
        
        // Load bookings on page load
        loadBookings();
        setInterval(loadBookings, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>



